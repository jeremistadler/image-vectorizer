<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Image Vectorizer List</title>
    <link href='http://fonts.googleapis.com/css?family=Roboto:100,400,300,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    <style>
        body {
            background: #f8f8f8;
            font-family: 'Roboto', sans-serif;
        }

        #imageContainer {
            display: flex;
            flex-wrap: wrap;
            max-width: 594px;
            margin: 0 auto;
        }

        .header {
            font-size: 36px;
            font-weight: 100;
            text-align: center;
            margin: 20px;
            margin-top: 40px;
            color: #383838;
        }

        .footer {
            font-size: 14px;
            font-weight: 300;
            text-align: center;
            margin: 20px;
            margin-bottom: 40px;
            color: #868686;
        }

        .drag-active {
            background: rgb(175, 225, 169);
            filter: blur(3px);
            -webkit-filter: blur(3px);
            transition: 0.3s;
        }

        .fade-out {
            opacity: 0;
            transition: 1.0s;
        }

        canvas {
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            margin: 5px;
        }

        .homeButton{
            transition: 0.3s;
        }

        .hidden{
            opacity: 0;
            transition: 0.3s;
        }
    </style>
</head>
<body>
    <header class="header"><span class="homeButton hidden"><i class="fa fa-home"></i></span> Larry Page</header>
    <div id="imageContainer"></div>
    <footer class="footer">Generated by Larry Page</footer>

    <script>
        var dnaItems = [];
        var imageContainer = document.getElementById('imageContainer');
        var homeButton = document.getElementsByClassName('homeButton')[0];

        var animateOut = function() {
            for (var i = 0; i < imageContainer.childNodes.length; i++) {
                imageContainer.childNodes[i].style.transitionDelay = imageContainer.childNodes.length - i;
                imageContainer.childNodes[i].classList.add('fade-out')
            }
        }

        var renderHome = function() {
            animateOut();
            homeButton.classList.add('hidden');

            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/api/organisms/top?limit=200', true);
            xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
            xhr.onload = function(e) {
                if (this.status != 200)
                    throw 'Could not get items';

                dnaItems = JSON.parse(this.response);
                dnaItems.sort(function(a, b) { return a.Generation - b.Generation });

                imageContainer.innerHTML = '';
                for (var i = 0; i < dnaItems.length; i++) {
                    (function(dna) {
                        var canvas = RenderDna(dna, imageContainer, 128);
                        canvas.onclick = function() {
                            renderOrganism(dna.Organism.Id);
                        }
                    })(dnaItems[i])
                }
            };
            xhr.send();
        }

        renderHome();

        var renderOrganism = function(id) {
            homeButton.classList.remove('hidden');
            homeButton.classList.remove('hidden');
            animateOut();

            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/api/dna/latest?limit=200&organismId=' + id, true);
            xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
            xhr.onload = function(e) {
                if (this.status != 200)
                    throw 'Could not get items';

                dnaItems = JSON.parse(this.response);
                dnaItems.sort(function(a, b) { return a.Generation - b.Generation });

                imageContainer.innerHTML = '';
                for (var i = 0; i < dnaItems.length; i++) {
                    RenderDna(dnaItems[i], imageContainer, 128);
                }
            };
            xhr.send();
        }


        function RenderDna(dna, container, size) {
            var canvas = document.createElement('canvas');
            canvas.width = size;
            canvas.height = size;
            var ctx = canvas.getContext('2d', { alpha: false });
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, size, size);
            container.appendChild(canvas);

            for (var g = 0; g < dna.Genes.length; g++) {
                var gene = dna.Genes[g];
                ctx.fillStyle = 'rgba(' +
                    Math.floor(gene.Color[0] * 255) + ',' +
                    Math.floor(gene.Color[1] * 255) + ',' +
                    Math.floor(gene.Color[2] * 255) + ',' +
                    (gene.Color[3] * 0.5) + ')';;

                ctx.beginPath();
                ctx.moveTo(gene.Pos[0] * size, gene.Pos[1] * size);
                ctx.lineTo(gene.Pos[2] * size, gene.Pos[3] * size);
                ctx.lineTo(gene.Pos[4] * size, gene.Pos[5] * size);
                ctx.closePath();
                ctx.fill();
            }

            return canvas;
        }

        var createOrganism = function(image) {
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/api/organism/save', true);
            xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
            xhr.onload = function(e) { };
            xhr.send(JSON.stringify({ geneCount: 50, imagePath: image }));
        }

        document.body.addEventListener('dragstart', function(e) { e.preventDefault(); document.body.classList.add('drag-active') });
        document.body.addEventListener('dragenter', function(e) { e.preventDefault(); document.body.classList.add('drag-active') });
        document.body.addEventListener('dragover', function(e) { e.preventDefault(); document.body.classList.add('drag-active') });
        document.body.addEventListener('dragleave', function(e) { e.preventDefault(); document.body.classList.remove('drag-active') });


        document.body.addEventListener('drop', function(e) {
            e.stopPropagation();
            e.preventDefault();
            document.body.classList.remove('drag-active');

            var files = e.dataTransfer.files;
            var formData = new FormData();

            for (var i = 0, file; file = files[i]; i++) {
                if (file.type.match(/image.*/)) {
                    formData.append(file.name, file);
                    var reader = new FileReader();
                    reader.onload = function(e2) {
                        var img = document.createElement('img');
                        img.src = e2.target.result;
                        img.style.width = '200px';
                        img.style.height = '200px';
                        document.body.appendChild(img);
                    }
                    reader.readAsDataURL(file);
                }
            }

            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/api/upload', true);
            xhr.onload = function(e) {
                var data = JSON.parse(xhr.response);
                for (var i = 0; i < data.length; i++) {
                    createOrganism(data[i]);
                }
            };
            xhr.send(formData);
        });
    </script>
</body>
</html>
