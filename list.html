<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Image Vectorizer List</title>
    <link href='http://fonts.googleapis.com/css?family=Roboto:100,400,300,700' rel='stylesheet' type='text/css'>
    <style>
        body {
            background: #f8f8f8;
            max-width: 594px;
            margin: 0 auto;
            font-family: 'Roboto', sans-serif;
        }

        svg {
            margin: 10px;
        }

        #container {
            display: flex;
            flex-wrap: wrap;
        }

        .header{
            font-size: 36px;
            font-weight: 100;
            text-align: center;
            margin: 20px;
            margin-top: 40px;
            color: #383838;
        }

        .footer{
            font-size: 14px;
            font-weight: 300;
            text-align: center;
            margin: 20px;
            margin-bottom: 40px;
            color: #868686;
        }

        .drag-active{
            background: rgba(230, 230, 230, 0.07);
            filter: blur(3px);
            -webkit-filter: blur(3px);
            transition: 0.3s;
        }
    </style>
</head>
<body>
    <header class="header">Larry Page</header>
    <div id="container"></div>

    <footer class="footer">Generated by Mona Lisa</footer>

    <!--<label for=versionInput>Version</label>-->
    <!--<input type=range min=0 max=1 value=0 id=versionInput>-->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.1.4/raphael-min.js"></script>

    <script>
        var dnaItems = [];
        var slider = document.getElementById('versionInput');
        var container = document.getElementById('container');

        var xhr = new XMLHttpRequest();
        //xhr.open('GET', 'http://localhost:2270/api/organisms/top?limit=200', true);
        xhr.open('GET', 'http://localhost:2270/api/dna/latest?limit=200&organismId=35', true);
        xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
        xhr.onload = function(e) {
            if (this.status != 200)
                throw 'Could not get items';

            dnaItems = JSON.parse(this.response);
            dnaItems.sort(function(a, b) { return a.Generation - b.Generation });
            //slider.max = dnaItems.length - 1;
            //slider.value = 0;

            for (var i = 0; i < dnaItems.length; i++) {
                RenderDna(dnaItems[i]);
            }

            //RenderDna(dnaItems[0]);
        };
        xhr.send();

        //slider.oninput = UpdateSlider;

        //function UpdateSlider() {
        //    RenderDna(dnaItems[parseInt(slider.value)]);
        //}

        function RenderDna(dna) {
            var size = 128;

            var paperDiv = document.createElement('div');
            container.appendChild(paperDiv);
            var paper = Raphael(paperDiv, size, size);

            for (var g = 0; g < dna.Genes.length; g++) {
                var gene = dna.Genes[g];

                var posString = 'M' + (gene.Pos[0] * size) + ' ' + ((1 - gene.Pos[1]) * size) + 'L';

                for (var p = 2; p < gene.Pos.length; p++) {
                    posString += gene.Pos[p] * size;
                    posString += ' ';
                }

                var path = paper.path(posString + 'Z');
                path.attr('fill', 'rgba(' +
                    gene.Color[0] * 255 + ',' +
                    gene.Color[1] * 255 + ',' +
                    gene.Color[2] * 255 + ',' +
                    gene.Color[3] * 0.5 + ')');

                path.attr('stroke-width', '0');
            }
        }

        var createOrganism = function(image) {
            var xhr = new XMLHttpRequest();
            xhr.open('POST', 'http://localhost:2270/api/organism/save', true);
            xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
            xhr.onload = function(e) {  };
            xhr.send(JSON.stringify({geneCount: 10, imagePath: image}));
        }

        document.body.addEventListener('dragstart', function(e) { e.preventDefault(); document.body.classList.add('drag-active') });
        document.body.addEventListener('dragenter', function(e) { e.preventDefault(); document.body.classList.add('drag-active') });
        document.body.addEventListener('dragover', function(e) { e.preventDefault(); document.body.classList.add('drag-active') });
        document.body.addEventListener('dragleave', function(e) { e.preventDefault(); document.body.classList.remove('drag-active') });


        document.body.addEventListener('drop', function(e) {
            e.stopPropagation();
            e.preventDefault();
            document.body.classList.remove('drag-active');

            var files = e.dataTransfer.files; 
            var formData = new FormData();

            for (var i = 0, file; file = files[i]; i++) {
                if (file.type.match(/image.*/)) {
                    formData.append(file.name, file);
                    var reader = new FileReader();
                    reader.onload = function(e2) {
                        var img = document.createElement('img');
                        img.src = e2.target.result;
                        img.style.width = '200px';
                        img.style.height = '200px';
                        document.body.appendChild(img);
                    }
                    reader.readAsDataURL(file);
                }
            }

            var xhr = new XMLHttpRequest();
            xhr.open('POST', 'http://localhost:2270/api/upload', true);
            xhr.onload = function(e) {
                var data = JSON.parse(xhr.response);
                for (var i = 0; i < data.length; i++) {
                    createOrganism(data[i]);
                }
            };
            xhr.send(formData);
        });
    </script>
</body>
</html>
